<!-- TODO: add moment-timezone for proper timezone handling -->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="presentation-timer" attributes="">
  <template>
    <link rel="stylesheet" href="presentation-timer.css">
    <firebase-element id="base" location="https://mta-conf.firebaseio.com/schedule/2015-04-03" data="{{data}}"
                      keys="{{keys}}"></firebase-element>
      <div id="marquee" class="{{ {happy: !almostOutOfTime, warning: almostOutOfTime} | tokenList}}" horizontal layout fullbleed>
        <div flex self-center>
          <h1>{{theTitle}}</h1>
          <template if="{{presenter}}">
            <img src="{{portrait}}">
            <h3>{{presenter}}</h3>
          </template>
          <div id="countdown">{{timeLeft}}</div>
        </div>
      </div>
  </template>
  <script>
    (function () {
      Polymer({
        almostOutOfTime: false,
        day: '2015-04-03',
        theTitle: 'The Title',
        timeLeft: '',
        getTimeDifference: function (earlierDate, laterDate) {
          var oDiff = {};

          //  Calculate Differences
          //  -------------------------------------------------------------------  //
          var nTotalDiff = laterDate.getTime() - earlierDate.getTime();
          oDiff.totalSeconds = nTotalDiff / 1000;

          oDiff.days = Math.floor(nTotalDiff / 1000 / 60 / 60 / 24);
          nTotalDiff -= oDiff.days * 1000 * 60 * 60 * 24;

          oDiff.hours = Math.floor(nTotalDiff / 1000 / 60 / 60);
          nTotalDiff -= oDiff.hours * 1000 * 60 * 60;

          oDiff.minutes = Math.floor(nTotalDiff / 1000 / 60);
          nTotalDiff -= oDiff.minutes * 1000 * 60;

          oDiff.seconds = Math.floor(nTotalDiff / 1000);
          //  -------------------------------------------------------------------  //

          //  Format Duration
          //  -------------------------------------------------------------------  //

          //  Format Days
          var daytext = '';
          if (oDiff.days > 0) {
            daytext = String(oDiff.days) + 'd ';
          }

          //  Format Hours
          var hourtext = '00';
          if (oDiff.hours > 0) {
            hourtext = String(oDiff.hours);
          }
          if (hourtext.length === 1) {
            hourtext = '0' + hourtext;
          }

          //  Format Minutes
          var mintext = '00';
          if (oDiff.minutes > 0) {
            mintext = String(oDiff.minutes);
          }
          if (mintext.length === 1) {
            mintext = '0' + mintext;
          }

          //  Format Seconds
          var sectext = '00';
          if (oDiff.seconds > 0) {
            sectext = String(oDiff.seconds);
          }
          if (sectext.length === 1) {
            sectext = '0' + sectext;
          }

          //  Set Duration
          var sDuration = daytext + hourtext + ':' + mintext + ':' + sectext;
          oDiff.duration = sDuration;
          //  -------------------------------------------------------------------  //

          return oDiff;
        },
        updateValues: function () {
          var self = this,
            now = new Date(),
            nothingIsHappening = true,
            nextEvent = null,
            timeDiff,
            isDayOfEvent = (now > new Date(self.day + 'T00:00') && now < new Date(self.day + 'T23:59:59'));
          if (!isDayOfEvent) {
            timeDiff = self.getTimeDifference(now, new Date(Date.parse(self.day + 'T09:00')));
            self.theTitle = 'The conference will begin at 9:00am MST on April 3, 2015.';
            self.timeLeft = timeDiff.duration;
          }
          else {
            self.theTitle = 'Nothing is happening.';
          }
          if (isDayOfEvent && self.data) {
            self.data.forEach(function (element) {
              var start = new Date(Date.parse(self.day + 'T' + element.start)),
                end = new Date(Date.parse(self.day + 'T' + element.end)),
                duration = self.getTimeDifference(start, end);
              if (now >= start && now <= end) {
                nothingIsHappening = false;
                self.theTitle = element.title;
                self.presenter = element.presenter;
                self.portrait = element.portrait;
                timeDiff = self.getTimeDifference(now, end);
                if (timeDiff.totalSeconds <= duration.totalSeconds * 0.1) {
                  self.almostOutOfTime = true;
                } else {
                  self.almostOutOfTime = false;
                }
                self.timeLeft = timeDiff.duration;
              }
              if (!nextEvent && nothingIsHappening && start > now) {
                nextEvent = element.presenter ? 'Up next...' : element.title + ' starts in';
                timeDiff = self.getTimeDifference(now, start);
                self.presenter = element.presenter;
                self.portrait = element.portrait;
                self.timeLeft = timeDiff.duration;
                self.theTitle = nextEvent;
                self.almostOutOfTime = false;
              }
            });
          }
          this.async(this.updateValues, null, 1000);
        },
        ready: function () {
          this.async(this.updateValues);
        }
      });
    })();
  </script>
</polymer-element>
